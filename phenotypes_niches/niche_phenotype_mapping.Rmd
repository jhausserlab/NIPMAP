---
title: "Niche-phenotype mapping in TNBC MIBI data"
author: "Anissa El Marrahi"
date: "4/7/2022"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

TMENs are 4 local niches that might explain inter-patient variability in tumor microenvionment cellular composition as a continuum. We previously showed that they help bridging micro (cells neighborhood) and macroscopic tumor architecture (CyTOF experiment on 5x5x5 mm tumors) on breast cancer samples.
TMENs were proved to be a a simple framework to study tumor architecture and accurate in the sense that it can retrieve the original tumor cell composition.

However, we still lack a quantitative framework to analyze the TME in a higher level of abstraction: cell phenotypes <--> cell markers expression. We know that for example, there is high variability in immune response of TILs (pro/anti-inflammation) within the tumor microenvironment. It is relevant to study how the environment impacts the differential expression of different markers at the single-cell level. However, a spatial coarse-grained approach is hard to tackle. The need for a simplified framework to study this question grows as the level of accuracy in the exploration of the tumor microenvironment increases. Therefore, it is legitimate to assess the relevance of TMENs as a framework to explore the phenotypical diversity of cells within the TME.

Are cell phenotypes driven by the environment in TNBC ?
To address this, we will study the local environment at the single-cell level. Instead of having cell positions (x,y), the local environment will be described as a vector \alpha with the proportions of TMENs of a site centered on each cell. We will study then the expression of specific markers of interest within specific cell types in function of \alpha. 

## Loading libraries and data

```{r libs}
gc()
rm(list=ls())
library(tidyverse)
library(plotly)
#library(reticulate)
library(ade4)
library(htmltools)
library(factoextra)
library('Ternary')
library(pheatmap)
source("./functions_phenotypes_tmens.r")
dirName <- dirname(rstudioapi::getSourceEditorContext()$path )
setwd(dirName)#setwd(dir = "/scratch/anissa.el/ImmuneStates/phenot_tmens")

```

### Constant variables

```{r constants}

CELLTYPES <- c('CD8-T', 'Other immune', 'DC / Mono', 'CD3-T', 'B', 'NK', 'Keratin-positive tumor', 'Tumor','CD4-T', 'Mesenchymal-like', 'Macrophages', 'Endothelial', 'Tregs', 'DC', 'Mono / Neu','Neutrophils')## Removed Unidentified cells
NBCELLTYPES = length(CELLTYPES)

MARKERS <- c("dsDNA","Vimentin","SMA","B7H3","FoxP3","Lag3","CD4","CD16","CD56","OX40","PD1","CD31","PD-L1","EGFR","Ki67","CD209","CD11c","CD138","CD163","CD68","CSF-1R","CD8","CD3","IDO","Keratin17","CD63","CD45RO","CD20","p53","Beta catenin","HLA-DR","CD11b","CD45","H3K9ac","Pan-Keratin","H3K27me3","phospho-S6","MPO","Keratin6","HLA_Class_1")
NBNICHES = 4

FIGSPATH= "./figs/"


```

### Sites and TMENs data

```{r data, echo=TRUE}
##CSV file of archetypes found by archetype analysis and their cell composition
archsCellAb <- read.csv("../TMENS_analysis/output/archetypes_cellAbundance.csv",check.names=FALSE,encoding = "UTF-8")
# ARCH1: TLS
# ARCH2: INFLAMMATORY NICHE
# ARCH3: CANCER NICHE
# ARCH4: FIBROTIC/NECROTIC NICHE

## .csv file containing the expression of markers from all cells from all images
cell_markers <- read.csv('../TMENS_analysis/data/cellData.csv',check.names=FALSE,header = TRUE, sep =',')

#colnames(cell_markers)
cell_markers <- cell_markers %>% relocate(Background, .after = cellLabelInImage)%>%
  dplyr::select(-c(cellSize,C,Na,Si,P,Ca,Fe,immuneCluster,Ta,Au))%>% 
  #dplyr::select(cell_markers,-c( immuneCluster, Ta, Au))%>% 
  mutate(immuneGroup = recode(immuneGroup,`0`= 'None',`1`='Tregs', `2`='CD4-T',
                              `3`='CD8-T', `4`='CD3-T', `5`='NK',
                    `6`='B', `7`='Neutrophils', `8`='Macrophages', `9`='DC',
                    `10`='DC / Mono', `11`='Mono / Neu', `12`='Other immune')) %>% 
  mutate(Group = recode(Group,`1`='Unidentified', `2`='Immune',
                        `3`='Endothelial', `4`='Mesenchymal-like',
                        `5` = 'Tumor',
                        `6` = 'Keratin-positive tumor'))

cell_markers <- cell_markers%>%
  mutate(cell_type = ifelse(Group == 'Immune', cell_type<- immuneGroup,cell_type <- Group))%>%
  dplyr::select(-c(tumorYN,tumorCluster,Group,immuneGroup))%>%filter(cell_type!="Unidentified")

cell_markers <- cell_markers%>%
  dplyr::rename(patient_id = SampleID)%>%
  dplyr::rename(cell_id = cellLabelInImage)%>%
  mutate(H3K9ac_H3K27me3 = H3K9ac/H3K27me3)

#### Select functional markers
##.csv file containing the markers and their use in MIBI (lineage, function)
stateMarkers <- read.csv("./data/proteins_by_frame.csv")
FuncMarkers <- stateMarkers%>%filter(Purpose =="Functional")%>%pull(Biomarker)

#names of archetypes found by AA
niches <- unlist(lapply(as.vector(seq(1:NBNICHES)),function(x){paste0("arch",x)}))
#FuncMarkers <- append(str_replace_all(FuncMarkers,c("HLA-DR"="HLA.DR","PD-L1" = "PD.L1","phospho-S6" = "phospho.S6","Beta catenin" = "Beta.catenin")),"H3K9ac_H3K27me3")

```




#### Hierarchical clustering of cell types by functional markers

```{r hclustCT,eval=TRUE}
### FUNCTION ###
hclust_cellTypes(dfCellsMarkers = cell_markers,cellTypes = c("DC", "NK", "Neutrophils", "Tregs","Macrophages"),nClusts=10,markers=FuncMarkers)

```



```{r tmensCells}
##.csv file containing the TMENs proportion of cells
tmens_cells2 <- read.csv("../TMENS_analysis/output/archetypes_sites_centered_cells_gaussian2.csv")%>%filter(cell_type_site!="Unidentified")
#rowSums(tmens_cells[,c("archetype1","archetype2","archetype3","archetype4")])

```




```{r eval=FALSE,CMdensity}

sitesCellsCM <- left_join(markersPerCell%>%rename(site_id=cell_id),tmens_cells2, by=c("patient_id","site_id"))%>%filter(!is.na(cell_type_site))

ggplot(sitesCellsCM%>%filter(marker=='Keratin6'),aes(x=TOT_cell_dens,y=value))+
  geom_point(alpha=.02)+
  geom_density_2d()
  #stat_cor(method="spearman",cor.coef.name="rho",label.x=0.015,label.y=6)

ggplot(sitesCellsCM%>%filter(marker=='Keratin6'),aes(y=value, group=cell_type,fill=cell_type))+
  geom_boxplot()

ggplot(sitesCellsCM%>%filter(marker=='Beta catenin'),aes(x=TOT_cell_dens,y=value))+
  geom_point(alpha=.02)+
  geom_density_2d()

```


## Quantification of cells' local environment: niches and interface

```{r tmens, echo=TRUE}
#MarkersCells.var <- left_join(selectedMarkers, markersPerCell,by= c("cell_type","marker"))
### Markers expr for all cell types from all sites
markersPerCell <- cell_markers%>%pivot_longer(cols = append(MARKERS,"H3K9ac_H3K27me3") ,names_to = "marker", values_to= "value")
#FIXME computing interfaces: use combn to allow more interfaces for # niches>4 (see Ziqi's suggestion code)

if (file.exists("./outputs/MarkersCellsTMENs.rds")){
  MarkersCellsTMENS <- readRDS("./outputs/MarkersCellsTMENs.rds")
}else{
  MarkersCellsTMENS <- left_join(markersPerCell%>%rename(site_id=cell_id),tmens_cells2, by=c("patient_id","site_id"))%>%filter(!(is.na(arch1)| is.na(arch2)| is.na(arch3) | is.na(arch4)))%>%
  mutate(a1a2 = arch1*arch2)%>%
  mutate(a1a3 = arch1*arch3)%>%
  mutate(a1a4 = arch1*arch4)%>%
  mutate(a2a3 = arch2*arch3)%>%
  mutate(a2a4 = arch2*arch4)%>%
  mutate(a3a4 = arch3*arch4)%>%
  mutate(a1a2a3 = arch1*arch2*arch3)%>%
  mutate(a1a2a4 = arch1*arch2*arch4)%>%
  mutate(a1a3a4 = arch1*arch3*arch4)%>%
  mutate(a2a3a4 = arch2*arch3*arch4)%>%
  mutate(a1a2a3a4 = arch1*arch2*arch3*arch4)
  
  saveRDS(MarkersCellsTMENS,"./outputs/MarkersCellsTMENs.rds")
}

MarkersCellsTMENS2 <- left_join(markersPerCell%>%rename(site_id=cell_id),tmens_cells2, by=c("patient_id","site_id"))%>%filter(!(is.na(arch1)| is.na(arch2)| is.na(arch3) | is.na(arch4)))%>%
  mutate(a1a2 = arch1*arch2)%>%
  mutate(a1a3 = arch1*arch3)%>%
  mutate(a1a4 = arch1*arch4)%>%
  mutate(a2a3 = arch2*arch3)%>%
  mutate(a2a4 = arch2*arch4)%>%
  mutate(a3a4 = arch3*arch4)%>%
  mutate(a1a2a3 = arch1*arch2*arch3)%>%
  mutate(a1a2a4 = arch1*arch2*arch4)%>%
  mutate(a1a3a4 = arch1*arch3*arch4)%>%
  mutate(a2a3a4 = arch2*arch3*arch4)%>%
  mutate(a1a2a3a4 = arch1*arch2*arch3*arch4)

#MarkersCellsTMENS.selected <- left_join(selectedMarkers,MarkersCellsTMENS,by=c("cell_type","marker"))#left_join(MarkersCells.var%>%rename(site_id=cell_id),tmens_cells, by=c("patient_id","site_id"))
#saveRDS(MarkersCellsTMENS,"./markers_cells_tmens.rds")

```

Plot the proportions of TMENs and show the intensity of the marker for cell type


```{r plotNeutrPDL1, eval=FALSE}

# MarkersCellsTMENS1 <- MarkersCellsTMENS%>%dplyr::rename(TLS=arch1)%>%
#   dplyr::rename(inflamm = arch2)%>%dplyr::rename(fibrotic=arch4)%>%
#   dplyr::rename(cancer=arch3)
### FUNCTION ###
plot_cellMarker_niche(MarkersCellsTMENS2,"Keratin-positive tumor","HLA_Class_1",niche=c("inflammatory","cancer"))

plot_cellMarker_niche(MarkersCellsTMENS2,"Tregs","phospho-S6",niche=c("inflammatory","cancer"))

plot_cellMarker_niche(MarkersCellsTMENS2,"Neutrophils","HLA-DR",niche="inflammatory")

plot_cellMarker_niche(MarkersCellsTMENS2,"Neutrophils","PD-L1",niche=c("inflammatory","cancer"))

plot_cellMarker_niche(MarkersCellsTMENS2,"Neutrophils","IDO",niche=c("inflammatory","cancer"))

plot_cellMarker_niche(MarkersCellsTMENS2,"NK","CD138",niche="fibrotic")

#### Does not follow a normal distribution
## Many extreme outliers 
# spearman correlations instead
NeutroPDL1 <- MarkersCellsTMENS2%>%filter(cell_type=="Neutrophils"& marker=="PD-L1")%>%pull(value)
hist(NeutroPDL1,breaks = 100,xlim=c(0,3))

boxplot(NeutroPDL1)
summary(NeutroPDL1)
shapiro.test(NeutroPDL1)
qqnorm(NeutroPDL1, pch = 1, frame = FALSE)
NeuPDL1.tmen  <- MarkersCellsTMENS2%>%
  filter(cell_type=="Neutrophils"& marker=="PD-L1")%>%
  mutate(inflxcancer=inflamm*cancer)%>%
  mutate(intf = ifelse(inflxcancer<0.1,0,1))%>%
  mutate(pdl1= ifelse(value<1,0,1))
hist(pull(NeuPDL1.tmen,inflxcancer),breaks=50)
tab1 <-table(NeuPDL1.tmen%>%dplyr::select(c(intf,pdl1)))
fisher.test(tab1) #### Non-significant contigency table ==> the count of PDL1+ Neutrophils is independent from interface positivity
#qqline(NeutroPDL1, col = "steelblue", lwd = 2)

# ggplot(data=MarkersCellsTMENS1%>%filter(cell_type=="Neutrophils"& marker=="PD.L1"),aes(y=value))+
#   geom_boxplot()

```



```{r plot1, eval=FALSE,fig.width= 12,echo=FALSE}

library(ggpubr)
####POSITIVE CONTROLS
## HLA CLASS I IN KERATIN-POSITIVE TUMORS
plot_cellMarker_niche(MarkersCellsTMENS2,"Keratin-positive tumor","HLA_Class_1",niche=c("inflammatory","cancer"))
## BETA CATENIN IN CD8 T CELLS
plot_cellMarker_niche(MarkersCellsTMENS2,"CD8-T","Beta catenin",niche=c("cancer","fibrotic"))

#### NEGATIVE CONTROLS
## dsDNA in KERATIN POSITIVE TUMORS VS CANCER
plot_cellMarker_niche(MarkersCellsTMENS2,"Keratin-positive tumor","dsDNA",niche="cancer")

## dsDNA in KERATIN POSITIVE TUMORS VS INFLAMM Neutrophils;CD45RO in TLS
plot_cellMarker_niche(MarkersCellsTMENS2,"Neutrophils","CD45RO",niche="TLS")

### RANDOM CONTROLS (8 ct-markers VS TMENs)
TMENs <- c("TLS","inflammatory","cancer","fibrotic")
set.seed(12)
rand.ct <- sample(CELLTYPES, 8)
rand.markers <- sample(MARKERS,8)
rand.tmens <- sample(TMENs,8,replace=TRUE)

# MarkersCellsTMENS2 <- MarkersCellsTMENS2%>%pivot_longer(cols=c("cancer","TLS","inflammatory","fibrotic"),names_to="tmen",values_to = "tmen_prop")
# randCMs <- tibble(cell_type=rand.ct,marker=rand.markers,tmen=rand.tmens)
# #merge(MarkersCellsTMENS2,randCMs, by=c("cell_type","marker","tmen"))
# 
# randsToPlot <- right_join(MarkersCellsTMENS2%>%dplyr::select(c(cell_type, marker, tmen, value, tmen_prop)),randCMs, by=c("cell_type","marker","tmen"))%>%mutate(ctMarker = paste0(cell_type,";",marker, " VS ",tmen))#%>%group_by(cell_type, marker,tmen)%>%summarise(count=n())
# ggplot(data=randsToPlot,aes(x=tmen_prop,y=value))+
#   facet_wrap(~ctMarker,nrow=2,ncol=4)+
#   geom_point(alpha=.01)+
#   geom_density_2d()+
#   stat_cor(method="spearman",cor.coef.name="rho",label.x=0.30)

#MarkersCellsTMENS2%>%group_by(cell_type, marker, tmen)%>%filter(cell_type==randCMs$cell_type & marker ==randCMs$marker & tmen ==randCMs$tmen)

```


## Linear relationship between markers and TMENS ?


### Multivariate linear analysis of cell phenotypes-TMENs associations

```{r linReg1, eval=TRUE,echo=TRUE}

coreIntfNiches <- c("arch1","arch2","arch3","arch4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4","a1a2a3","a1a2a4","a1a3a4","a2a3a4","a1a2a3a4")
CellT <- c('CD8-T' , 'B', 'NK', 'Keratin-positive tumor', 'Tumor','CD4-T', 'Mesenchymal-like', 'Macrophages', 'Endothelial', 'Tregs', 'DC','Neutrophils')
coreIntf2 <- c("arch1","arch2","arch3","arch4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4")# core and interface order 2 niches

#View(dfStats2)#%>%filter(niche=="a2a3"))

### Get predicted proportions of inflammatory niche of DCs 
#Predlm.DCa2 <- predict.lm(lm(alpha ~ Beta.catenin + CD138 + CD45RO + CD63 + FoxP3 + H3K27me3 + H3K9ac +  HLA.DR + HLA_Class_1 + IDO + Keratin17 + Keratin6 + Ki67 + Lag3 + p53 + PD.L1 + PD1 + phospho.S6, data =MarkersCellsTMENs.byNiche%>%
#                               filter(cell_type=="DC" & niches=="arch2")))#mutate(patient_id=str_split(id,"_")[[1]])

#   separate(col=id,into= c("SampleID","label","cell_type","arch"),sep="_",convert=TRUE)
 
# write_csv(PredDCa2.df,"./outputs/predictedlm_alfa_a2_DC.csv")
# boxplot(Predlm.DCa2)
# hist(Predlm.DCa2)
# 
#PredDCa2.df <- data.frame(id=names(Predlm.DCa2), value = Predlm.DCa2,row.names = NULL)%>%mutate(inflammatory_niche_pred = ifelse(value>=.5,1,0))%>%

lmStats <- lm_niches_phen(markersCells.niches=MarkersCellsTMENS2,markers=FuncMarkers, cell_types=CellT,coreIntfNiches=coreIntf2)


```

#### FDR correction over estimates' p-values 

```{r FDRt,fig.width=12,fig.height=6, eval=TRUE, echo=TRUE}

filtered.tstat <- fdr_lm_niches(lmStats=lmStats,qvalTresh=0.01)

## Select max t-stat per cell phenotype
maxNiches <- apply(filtered.tstat,1,max)
plot(sort(maxNiches))

as.vector(filtered.tstat)%>%summary
filtered.tstat2 <- filtered.tstat[names(sort(maxNiches,decreasing=TRUE)[1:110]),]#[names(maxNiches[maxNiches>3]),]#[names(sort(maxNiches)[1:75]),]
#plot(sort(apply(filtered.tstat2,2,max)))
filtered.tstat2[filtered.tstat2>5] = 5
filtered.tstat2[filtered.tstat2<(-5)] = -5
pheatmap(filtered.tstat2%>%t)


```



```{r heatmapLM, eval=TRUE,echo=TRUE}
### heatmap TEST
library(pheatmap)
pheatmap(filtered.tstat2%>%t)
#pheatmap(filtered.tstat[maxMatch.t==TRUE,]%>%t)

figWidth <- nrow(filtered.tstat2%>%t)*300/267#nrow(filtered.tstat[maxMatch.t==TRUE,]) * 30/267

pdf("./figs/t_statMatrix.pdf", height=6, width=ifelse(figWidth<6, 6, figWidth+2));
 pheatmap(filtered.tstat2%>%t);# (filtered.tstat[maxMatch.t==TRUE,]%>%t)
dev.off()

rownames(filtered.tstat2) <- str_replace_all(rownames(filtered.tstat2),"(?<=;)[:digit:]{2,6};","")

#library(RColorBrewer)
library(pheatmap)
cts <- unique(pull(as_tibble(filtered.tstat2,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";"),cell_type))

markers2 <- unique(pull(as_tibble(filtered.tstat2,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";"),marker))

CMt_ct <- as_tibble(filtered.tstat2,rownames=NA)%>%
     rownames_to_column(var="names")%>%
     separate(names,into=c("cell_type","marker"),sep=";")%>%
     pivot_longer(cols=c('arch1','arch2','arch3',"arch4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4"),names_to = "region",values_to="corr_val")%>%
    mutate(idx =match(cell_type, cts))%>%
    group_by(cell_type)%>%
    mutate(corr_val = corr_val+ (idx-1)*10)%>%
    pivot_wider(names_from="region", values_from="corr_val")%>%
    mutate(names = paste(cell_type,marker,sep=";"))%>%
    column_to_rownames(var="names")#%>%dplyr::select(-c(cell_type,idx))

dists <- dist(as.matrix(CMt_ct%>%dplyr::select(-c(cell_type,marker,idx))),method="euclidean")
hclustCells <- hclust(dists,method="ward.D") 
#plot(as.dendrogram(hclustCells))

## Annotations colors = length of cell types
cellTypes <- data.frame(cell_type =pull(CMt_ct ,cell_type))
Markers<- pull(CMt_ct ,marker)

colorCount = length(unique(pull(CMt_ct ,cell_type)))
getPalette = colorRampPalette(RColorBrewer::brewer.pal(9, "Set1"))
getPalette(colorCount)
# List with colors for each annotation.
CTcolors <- list(cell_type = getPalette(colorCount))
names(CTcolors$cell_type) <- unique(pull(CMt_ct ,cell_type))
rownames(cellTypes) <- rownames(CMt_ct)
#rownames(Markers) <-rownames(CM_TMENs_ct)
pdf("./figs/tMat_byCells.pdf",height=7, width=ifelse(figWidth<6, 6, figWidth+4))
pheatmap(t(filtered.tstat2),cluster_cols = hclustCells,cluster_rows = FALSE,annotation_col=cellTypes,annotation_colors= CTcolors,labels_col = Markers,border_color = "grey")#
dev.off()


```



```{r ROC, eval=TRUE,echo=TRUE}
#install.packages("pROC")

### FUNCTION ###
CTroc <- c("DC","Neutrophils","NK","Tregs")
fileExt <- "_hclustIDs.csv"
clustCells <- list("DC"= c(1,2,3,4,5,6,7,8,9,10),
                   "Neutrophils"= c(1,2,3,4,5,6,7,8,9,10),
                   "Tregs"= c(1,2,3,4,5,6,7,8,9,10),
                   "NK"= c(1,2,3,4,5,6,7,8,9,10))

plot_roc_niches_cells(CT = CTroc,clustFiles = fileExt,clustIDs = clustCells, 
                      nichesNames = niches,markers = FuncMarkers, cellsNiches= tmens_cells2,
                      MarkersCells.niches = MarkersCellsTMENS2)#MarkersCellsTMENs.byNiche

```


### Assessing phenotypes-TMENs with spearman correlations

```{r nichesWeights, eval=FALSE, warning=FALSE}
#coreIntf2<-c("a1","a2","a3","a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4")
#MarkersCellsTMENS2%>%group_by(cell_type,marker)%>%
NINTERFACES = 2
NBNICHES = 4
getInterNiches <- function(nIntf,nbNiches){
  interfaces <- combn(paste0("a",as.vector(seq(1,nbNiches,1))),nIntf)
  coreIntf <- apply(interfaces,2,function(x) paste0(x,collapse=""))
  return(coreIntf)
}

coreIntf2 <- append(paste0("a",as.vector(seq(1,NBNICHES,1))),getInterNiches(NINTERFACES,NBNICHES))

 CM.gps <- MarkersCellsTMENS2%>%dplyr::rename(a1=arch1)%>%dplyr::rename(a2 = arch2)%>%dplyr::rename(a3 = arch3)%>%dplyr::rename(a4 = arch4)%>%
   filter(marker %in%FuncMarkers)%>%
   mutate(id=paste(cell_type,marker,sep=";"))%>%
     group_by(cell_type, marker)%>%split(f= as.factor(.$id))
   #print(CM.gps)

res <- lapply(CM.gps,function(x){
     for(n in coreIntf2){
       #print(n)
       #if (n %in%paste0("a",as.vector(seq(1,NBNICHES,1))) &(length(x%>%filter(get(n)>0.5)%>%pull(get(n)))==0)){
       #    print(unique(x$id))
       #    print(n)
       #}
       if ((n %in%getInterNiches(NINTERFACES,NBNICHES)) &(length(x%>%filter(get(n)>(1/8))%>%pull(get(n)))==0)){
           print(unique(x$id))
           print(n)
        }
    }
})

corr_niches_CM <- function(markersCells.niches,Markers,corrMeth="spearman",NINTERFACES=2,NBNICHES=4,qThresh=1/100,corThresh=0.3){
  rareCells<- markersCells.niches%>%group_by(cell_type)%>%summarise(total=n())%>%filter(total<=3*length(Markers))%>%pull(cell_type)
  if (length(rareCells)>=1){
    print("These cell types are rare (count<10),")
    print(rareCells)
  }
  #print("They will be removed from the correlation analysis")
  coreIntf <- append(paste0("a",as.vector(seq(1,NBNICHES,1))),getInterNiches(NINTERFACES,NBNICHES)) 
  CM.gps <- markersCells.niches%>%filter(!cell_type %in% rareCells)%>% #removing rare cell types
    filter(marker %in% Markers)%>%
    mutate(id=paste(cell_type,marker,sep=";"))%>%
    group_by(cell_type, marker)%>%split(f= as.factor(.$id))
  #print(CM.gps)
  res <-lapply(CM.gps,function(x){ #a%>%group_by(cell_type, marker)%>%group_split()%>%setNames(id)
    corrs <- c()
    corrpvals <-c()
    #id <- paste0(unique(pull(x,cell_type)),unique(pull(x,marker)),sep=";")
    #print(id)
    for(n in coreIntf){
      if(any(is.na(pull(x,value))|sd(pull(x,value))==0 |length(pull(x,value))<3)){
        corrValue <- NA
        corrp <- NA
      }
      else{
        if ((n %in%getInterNiches(NINTERFACES,NBNICHES) &(length(x%>%filter(get(n)>(1/8))%>%pull(get(n)))==0))|((n %in%paste0("a",as.vector(seq(1,NBNICHES,1))) & (length(x%>%filter(get(n)>0.5)%>%pull(get(n)))==0)))){
          print(unique(x$id))
          print()
          corrValue <- 0
          corrp <- 0
        }
        else{
          corrValue <- cor.test(pull(x,value),pull(x,get(n)),method = corrMeth,exact=FALSE)$estimate
          corrp <- cor.test(pull(x,value),pull(x,get(n)),method = corrMeth,exact=FALSE)$p.value 
        }
      }
      corrs <-append(corrs,corrValue)
      corrpvals <- append(corrpvals,corrp)
    }
    #print(corrs)
    names(corrs) <- coreIntf2
    names(corrpvals) <- coreIntf2
    list("corr_value"=corrs,"p_value"= corrpvals)
  })
  #print(names(res))
  CorrMat <- do.call(rbind,lapply(res,'[[',"corr_value"))#do.call(rbind,res["corr_value"])
  CorrpVal.mat <- do.call(rbind,lapply(res,'[[',"p_value"))#do.call(rbind,res[[2]])
  #print(CorrpVal.mat)
  corCMniches.pval <- CorrpVal.mat%>%as_tibble(rownames=NA)%>%
    rownames_to_column(var="names")%>%
    drop_na()
  write_csv(as_tibble(CorrMat,rownames=NA), "./rawCorrMatrix.csv")
  filtMat <- correct_cor_fdr(CorrMat,corCMniches.pval,qThresh,corThresh)
  #mean(apply(filtMat, 1, sum) > 0)
  cM.filt <- CorrMat[names(which(apply(filtMat, 1, sum) > 0)),]
  return(cM.filt) #return(CorrpVal.mat)
}

MarkersCellsNiches <- MarkersCellsTMENS2%>%dplyr::rename(a1=arch1)%>%dplyr::rename(a2 = arch2)%>%dplyr::rename(a3 = arch3)%>%dplyr::rename(a4 = arch4)

CMnew <- corr_niches_CM(MarkersCellsNiches,FuncMarkers,corrMeth="spearman",NINTERFACES=2,NBNICHES=4,qThresh=1/100,corThresh=0.3)

#plot_cellMarker_niche(MarkersCellsTMENS2,"Neutrophils","HLA_Class_1",niche=c("TLS","cancer"))
# cMf <- CMnew
# Krt.filt <- names(which(cMf[rownames(cMf)[which(grepl("Keratin6",rownames(cMf),fixed=TRUE))],"a3"]>0.3))
# BCat.filt <- names(which(cMf[rownames(cMf)[which(grepl("Beta catenin",rownames(cMf),fixed=TRUE))],"a3"]>0.2))
# 
# cMf2 <- cMf[!rownames(cMf)%in%BCat.filt& !rownames(cMf)%in% Krt.filt,]
# 
# pheatmap(cMf2%>%t)


```

```{r  corrsNew,eval=FALSE,warning=FALSE}

correlation_niches_CM2 <- function(markersCells.niches,Markers,corrMeth="spearman",coreIntf,qThresh=1/100,corThresh=0.3,intf,nbNiches){
  rareCells<- markersCells.niches%>%group_by(cell_type)%>%summarise(total=n())%>%filter(total<=3*length(Markers))%>%pull(cell_type)
  if (length(rareCells)>=1){
    print("These cell types are rare (count<10),")
    print(rareCells)
  }
  #print("They will be removed from the correlation analysis")
  CM.gps <- markersCells.niches%>%filter(!cell_type %in% rareCells)%>% #removing rare cell types
    filter(marker %in% Markers)%>%
    pivot_longer(cols=coreIntf,names_to = "niche",values_to = "weight")%>%
    mutate(id=paste(cell_type,marker,niche,sep=";"))%>%
    mutate(threshNiche= ifelse(niche%in%paste0("a",as.vector(seq(1,nbNiches,1))),1/2,1/8))%>% # determine cutoff for cells presence in niche or interface
    group_by(cell_type, marker,niche)%>%split(f= as.factor(.$id))
  #print(CM.gps)
  print("ok")
  
  #Filter out cells phenotyes-niches that don't have at least one cell present in niche or interface
  CMgps.filt <- CM.gps[lapply(CM.gps,function(x) length(x%>%filter(weight>threshNiche)%>%pull(weight)))>1]
  print(length(CM.gps))
  print(length(CMgps.filt))
  #print(CMgps.filt[["arterial;JAG1;a4"]])
  res <-lapply(CMgps.filt,function(x){ #a%>%group_by(cell_type, marker)%>%group_split()%>%setNames(id)
    #corrs <- c()
    #corrpvals <-c()
    #id <- paste0(unique(pull(x,cell_type)),unique(pull(x,marker)),sep=";")
    #print(id)
    #cellPhen.names <- append(cellPhen.names,id)
    #Compute correlations and p-value test
    corrValue <- cor.test(pull(x,value),pull(x,weight),method = corrMeth,exact=FALSE)$estimate
    corrp <- cor.test(pull(x,value),pull(x,weight),method = corrMeth,exact=FALSE)$p.value 
    dfres <- data.frame(rho = corrValue,pvalue = corrp)
    rownames(dfres) <- unique(x$id)
    
    dfres

  })
  #print(names(res))
  #print(names(res))
  CM2 <- do.call(rbind,res)

  corrOut <- bind_rows(CM2, .id = "id")
  corMatrix <- as.matrix(corrOut%>%dplyr::select(rho))

  ######FDR CORRECTION
  corCMtmens.pval.mat = corrOut%>%
    #dplyr::select(c(pvalue))%>%
    drop_na()#%>%
    #column_to_rownames(var="id")#corCMtmens.pval %>% column_to_rownames(var='names')
  #hist(as.matrix(corCMtmens.pval.mat%>%dplyr::select((pvalue)))%>%as.numeric)

  fdrOut =fdrtool(as.matrix(corCMtmens.pval.mat%>%dplyr::select((pvalue)))%>%as.numeric,statistic = "pvalue")
#write_csv(as.data.frame(corCMtmens.pval.mat,row.names=rownames(corCMtmens.pval.mat)),"./NiPhpvalue.csv")
#saveRDS(as.data.frame(corCMtmens.pval.mat,row.names=rownames(corCMtmens.pval.mat)),"./NiPhpvalue.rds")
  corCMtmens.qval <-fdrOut$qval %>%
  matrix(nrow=nrow(corCMtmens.pval.mat), ncol=1,
         dimnames = list(rownames(corCMtmens.pval.mat), "qvalue"))
  #write_csv(as.data.frame(corCMtmens.qval,row.names=rownames(corCMtmens.qval)),"./NiPhqvalue.csv")
#saveRDS(as.data.frame(corCMtmens.qval,row.names=rownames(corCMtmens.qval)),"./NiPhqvalue.rds")
  #hist(corCMtmens.qval)
  # Build q-value matrix for all niches/interfaces
  corQval <- corCMtmens.qval%>%as_tibble(rownames=NA)%>%
    rownames_to_column(var="id")%>%
    separate(col=id, into=c("ct","marker","niche"),sep=";")%>%
    mutate(id= paste0(ct,";",marker),.keep="unused")%>%#column_to_rownames(var="id")%>%
    pivot_wider(id_cols=id, names_from= niche,values_from=qvalue)%>%
    column_to_rownames(var="id")%>%
    replace(is.na(.),1)
  print(head(corQval))
  
  if(ncol(corQval)!=length(coreIntf)){
    corQval[,coreIntf[!(coreIntf %in% colnames(corQval))]]<-0
   }
  
  ##Build correlation matrix for all niches/interfaces
  colnames(corMatrix)<-"correlation"
  corMatrix2 <- corMatrix%>%as_tibble(rownames=NA)%>%
    rownames_to_column(var="id")%>%
    separate(col=id, into=c("ct","marker","niche"),sep=";")%>%
    mutate(id= paste0(ct,";",marker),.keep="unused")%>%#column_to_rownames(var="id")%>%
    pivot_wider(id_cols=id, names_from= niche,values_from=correlation)%>%
    column_to_rownames(var="id")%>%
    replace(is.na(.),0)
  
    if(ncol(corMatrix2 )!=length(coreIntf)){
    corMatrix2 [,coreIntf[!(coreIntf %in% colnames(corMatrix2 ))]]<-0
   }
  
  print(dim(corMatrix2 ))
  print(dim(corCMtmens.qval))
  ## FIlter correlations by qvalue and correlation threshold
  filterMat <- corQval<qThresh & corMatrix2[rownames(corQval),]>corThresh#corCMtmens.qval<qThresh & corMatrix2[rownames(corCMtmens.qval),]>corThresh
  # Keep cell phenotypes that are associated with at least one niche/interface, association being determined by correlation value >0.3 , q value<1/100
  cM.filt <- corMatrix2[names(which(apply(filterMat, 1, sum) > 0)),]%>%as.matrix
  #cMf2 <- cMf%>%replace(is.na(.),0)
  
  return(cM.filt)#(corQval)#(cM.filt)
}


#MarkersCellsNiches <- MarkersCellsTMENS2%>%dplyr::rename(a1=arch1)%>%dplyr::rename(a2 = arch2)%>%dplyr::rename(a3 = arch3)%>%dplyr::rename(a4 = arch4)

#nichesIntf <- getInterNiches(2,NBNICHES)
CM2 <- correlation_niches_CM2(markersCells.niches=MarkersCellsTMENS2, 
                            Markers=FuncMarkers, 
                            corrMeth="spearman", 
                            coreIntf=coreIntf2, qThresh=1/100,corThresh =  0.3,intf=2,nbNiches=NBNICHES)

Krt.filt <- names(which(CM2[rownames(CM2)[which(grepl("Keratin6",rownames(CM2),fixed=TRUE))],"arch3"]>0.3))
BCat.filt <- names(which(CM2[rownames(CM2)[which(grepl("Beta catenin",rownames(CM2),fixed=TRUE))],"arch3"]>0.2))
# 
CM.filtered <- CM2[!rownames(CM2)%in%BCat.filt& !rownames(CM2)%in% Krt.filt,]
pheatmap(CM.filtered%>%t)

```

```{r plots1,eval=FALSE,warning=FALSE,echo=TRUE}
start_time <- Sys.time()
cMf <- correlations_tmens_CM(MarkersCellsTMENs=MarkersCellsTMENS2,cellTypes=CELLTYPES, markers=FuncMarkers,nbNiches=NBNICHES)
end_time <- Sys.time()
print(end_time - start_time)
write_csv(cMf%>%as_tibble(rownames=NA)%>%rownames_to_column(var="cell_marker"), "../CM_corr_tmens_thresh0.3.csv")

figWidth <- nrow(cMf) * 30/267
#pheatmap(cMf%>%t)

#### Correct bleed-over ==> remove cell Keratin6+ cell phenotypes inf cancer and inflamm x cancer
## Remove beta-catenin+ cell phenotypes: Beta-catenin is a non-specific marker involved ina wide range of pathways including cell communication and potentially immunosupression
#CELL PHENOTYPES TO REMOVE
Krt.filt <- names(which(cMf[rownames(cMf)[which(grepl("Keratin6",rownames(cMf),fixed=TRUE))],"a3"]>0.3))
BCat.filt <- names(which(cMf[rownames(cMf)[which(grepl("Beta catenin",rownames(cMf),fixed=TRUE))],"a3"]>0.2))

cMf2 <- cMf[!rownames(cMf)%in%BCat.filt& !rownames(cMf)%in% Krt.filt,]

pheatmap(cMf2%>%t)
#pdf("./figs/cMf.pdf", height=8, width=ifelse(figWidth<6, 6, figWidth+2)); pheatmap(cMf%>%t); dev.off()

######## ----- VISUALIZATION ----- ##########
# figWidth <- nrow(cMf) * 30/267
# pdf("cMf_original.pdf", height=10, width=21); pheatmap(cMf %>% t,cluster_rows=FALSE,cluster_cols=FALSE); dev.off()
# pdf("./figs/cMf_reduced.pdf", height=8, width=ifelse(figWidth<6, 6, figWidth+2)); pheatmap(cMf %>% t); dev.off()

```

compute correlations between niches and cell phenotypes

```{r corrs,warning=FALSE,eval=TRUE,echo=TRUE}
#cMf2 <- CM.filtered
source("./functions_phenotypes_tmens.r")
NINTERFACE = 2
#test1 <- c("arch1","arch2")
#a <- MarkersCellsTMENS2%>%filter(marker %in% FuncMarkers)%>%
#  #select(c(cell_type,marker,value,arch1,arch2,arch3,arch4,a1a2,a1a3,a1a4,a2a3,a2a4,a3a4,a1a2a3,a1a2a4,a1a3a4,a2a3a4,a1a2a3a4))%>%
#  mutate(id=paste(cell_type,marker,sep=";"))
coreIntf2<-c("a1","a2","a3","a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4")#,"a1a2a3","a1a2a4","a1a3a4","a2a3a4","a1a2a3a4")

#start_time <- Sys.time()
#corrMeth <- "spearman"# method to compute correlations. We recommend to use spearman unless your dataset respects pearson assumptions
MarkersCellsNiches <- MarkersCellsTMENS2%>%dplyr::rename(a1=arch1)%>%dplyr::rename(a2 = arch2)%>%dplyr::rename(a3 = arch3)%>%dplyr::rename(a4 = arch4)

cMf <- correlation_niches_CM(markersCells.niches=MarkersCellsNiches,Markers=FuncMarkers,corrMeth="spearman",coreIntf=coreIntf2,nbNiches=NBNICHES)#(markersCells.niches=MarkersCellsTMENS2,Markers=FuncMarkers,corrMeth="spearman",coreIntf=coreIntf2)

#write_csv(cMf%>%as_tibble(rownames=NA)%>%rownames_to_column(var="cell_marker"), "./outputs/CM_corr_niches_thresh0.3.csv")
figWidth <- nrow(cMf) * 30/267

Krt.filt <- names(which(cMf[rownames(cMf)[which(grepl("Keratin6",rownames(cMf),fixed=TRUE))],"a3"]>0.3))
BCat.filt <- names(which(cMf[rownames(cMf)[which(grepl("Beta catenin",rownames(cMf),fixed=TRUE))],"a3"]>0.2))

cMf2 <- cMf[!rownames(cMf)%in%BCat.filt& !rownames(cMf)%in% Krt.filt,]
pheatmap(cMf2%>%t)
#pdf("./figs/cMf2.pdf", height=8, width=ifelse(figWidth<6, 6, figWidth+2)); pheatmap(cMf2%>%t); dev.off()
# end_time <- Sys.time()
# print(end_time - start_time)

```

Reporting results in table (TMENs core & interface x cell phenotypes)

```{r tabCorrelations,fig.height=10, echo=TRUE}
library(grid)
library(gridExtra)
#install.packages("fontLiberation")
library(fontLiberation)

### NAMES of NICHES and INTERFACES
InftOrder <- 2
archNames <- c("a1" = "TLS","a2" = "inflammatory","a3" = "cancer","a4" = "fibrotic")
#TODO add different orders of interfaces.

#Archetype weights of randomly generated sites over TNBC patients images
archetypes_sites <- read.csv("./data/archetypes_matrix_gaussian.csv", header = TRUE, sep = ",")
saveRDS(archetypes_sites,"./data/archetypesSitesKeren.rds")
archetypesSitesKeren <- readRDS("./data/archetypesSitesKeren.rds")%>%dplyr::rename(a1=archetype1)%>%dplyr::rename(a2=archetype2)%>%dplyr::rename(a3=archetype3)%>%dplyr::rename(a4=archetype4)
#Cell abundance of sites
cellAbSites <- read_csv("./data/abundance_matrix_gaussian.csv")

nichesCellAb <- archsCellAb%>%mutate(archetype=str_replace_all(archetype,c("ARCH1"="TLS","ARCH2"="inflammatory","ARCH3"="cancer","ARCH4"="fibrotic")))%>%column_to_rownames(var="archetype")%>%t()%>%as_tibble(rownames=NA)%>%rownames_to_column(var="cell_type")
nichesCA.sort <- nichesCellAb%>%pivot_longer(cols = c("TLS","inflammatory","cancer","fibrotic"),names_to="niche",values_to="cell_density")%>%group_by(niche)%>%arrange(desc(cell_density))


archsSitesCellAb <- left_join(archetypesSitesKeren, cellAbSites,by=c("site_id","patient_id"))%>%pivot_longer(cols=append(CELLTYPES,"Unidentified"),names_to="cell_type",values_to= "cell_density")%>%ungroup()

# nichesCellAb <- lapply(archsSitesCellAb%>%pivot_longer(cols=c("a1","a2","a3","a4"),names_to="archetype",values_to = "prop")%>%group_split(archetype),function(x){x%>%filter(prop>=quantile(prop,c(0.99)))})
# # get cell abundance of sites that are the closest to the archetypes/niches
# 
# nichesCellAb2 <-do.call(rbind,nichesCellAb)
nichesCellAb2 <- nichesCellAb
nichesCellAb2[nichesCellAb2<0]<-0

#COLARCHS=c(rgb(255/255, 0/255, 223/255),rgb(255/255,0/255,0/255),rgb(70/255,203/255,236/255),rgb(0,0,0))
COLARCHS=c(rgb(0,0,0),rgb(70/255,203/255,236/255),rgb(255/255,0/255,0/255),rgb(255/255, 0/255, 223/255))

bplot <- ggplot(nichesCellAb2%>%pivot_longer(cols=c("TLS","inflammatory","cancer","fibrotic"), names_to="niche",values_to="cell_density"),aes(x = cell_type, y = cell_density,fill = niche))+
  geom_bar(stat = "identity",position = position_dodge(),width = 0.6)+
  theme(axis.text.x = element_text(angle = 90, vjust = .2))+
  scale_fill_manual(values = COLARCHS)+
  xlab ("") + ylab("cell density")
bplot

ggsave("./figs/barplotNichesMIBI.pdf",bplot,height=3,width=4)


### Get cell types enriched in each niche (take top 1% sites closest to niche)
#archsSitesCellAb <- left_join(archsSites, cellAbundSites,by=c("site_id","patient_id"))%>%pivot_longer(cols=append(CELLTYPES,"Unidentified"),names_to="cell_type",values_to= "cell_density")%>%ungroup()

archs.CT <- get_CT_enriched_all_archs(archsSitesCellAb,archNames,thresh = 0.99)%>%group_by(niche)%>%filter(!(cell_type %in% c("DC / Mono", "CD3-T", "Mono / Neu", "Other immune","Unidentified")))%>%mutate(cell_type = paste(unique(cell_type),collapse="\n"))%>%distinct(niche,cell_type)
#names(archs.CT) <- set_tmens_names(names(archs.CT))



tabTMENs2 <- as_tibble(cMf2,rownames=NA)%>%
  rownames_to_column(var="names")%>%
  separate(names,into=c("cell_type","marker"),sep=";")%>%
  mutate(marker=paste0(marker,"+"))%>%
  pivot_longer(cols=coreIntf2,names_to = "niche",values_to="corr_val")#%>%
  #mutate(region =)%>%#(region = set_tmens_names(region))%>%
tabTMENs2$niche <- str_replace_all(pull(tabTMENs2,niche), c("a2a3"="inflammatoryxcancer",
                                                           "a1a3" = "TLSxcancer",
                                                           "a1a2" = "TLSxinflammatory",
                                                           "a1a4" = "TLSxfibrotic",
                                                           "a2a4" = "inflammatoryxfibrotic",
                                                           "a3a4" = "cancerxfibrotic"))
tabTMENs2$niche <- str_replace_all(pull(tabTMENs2,niche),archNames)

tabTMENs2 <- tabTMENs2%>% filter(corr_val >=0.3)%>%
  #filter(!(grepl("cancer",niche,fixed=TRUE) & (marker%in% c("Keratin6+","Beta catenin+"))))%>%
  left_join(.,nichesCA.sort, by=c("cell_type","niche"))%>%
  group_by(niche)%>%arrange(desc(cell_density))%>%dplyr::select(-c(cell_density))#### Select correlations that are >0.35 + remove correlations that arise from bleed over of structural proteins in cancer and interfaces with cancer.

#  full_join(.,archs.CT,by="region")%>%group_by(region,cell_type.x,marker)%>%mutate(cell_type.y = paste(unique(cell_type.y),collapse="\n"))%>%ungroup()#left_join(., archs.CT,by=c("region","cell_type")) #### include cell_types that are representative of a given region

######### Compare correlations from core VS from interfaces
  # group by cell type, marker
  #find rows with a common determinant: a niche
    # split region into two (for 2- interfaces)
    # find intersect between two subregions ==> common TMEN
    # OR find the niche that has the highest occurence in a subregion (core and interfacees) across same CM VStmens associations
    # OR the same but for the second subregion
    # IF there is an association between CM and one region ==> common region is the latter
  # group again by cell type, marker, and by this common region
  # select the maximum correlation value rho
  # Get correlations among core/interfaces for a given cell type/marker that are the highest
  # Ex: rho (Beta-cat+ Tregs; cancer) < rho( Beta-cat+ Tregs; cancer x fibrotic) 
  # ==> select rho( Beta-cat+ Tregs, cancer x fibrotic)
namesIntf <- paste0(rep("type",InftOrder),as.character(as.vector(seq(1,InftOrder))))

tabCellPhen <- tabTMENs2%>%separate(col=niche, into = c("type1","type2"),sep="x")%>%group_by(cell_type,marker)%>%mutate(len= length(type1))%>%mutate(inter_region=ifelse(len==1,type1,
                                                                                                                                                                    ifelse(head(sort(table(type1),decreasing=TRUE),1)>1, names(head(sort(table(type1),decreasing=TRUE),1)),
                                                                                                                                                                          ifelse(head(sort(table(type2),decreasing=TRUE),1)>1,  names(head(sort(table(type2),decreasing=TRUE),1)),ifelse(length(intersect(type1,type2))==0,paste(type1,type2,sep="x"),intersect(type1,type2) )))))%>%group_by(cell_type, marker,inter_region)%>%filter(corr_val==max(corr_val))


tabCellPhen2 <- tabCellPhen %>%
  mutate(niche = paste(type1,type2,sep=" x "))%>%
  #full_join(.,archs.CT,by=("region"))%>%
  mutate(niche=str_replace_all(niche," x NA",""))%>%
  filter(!(cell_type %in% c("DC / Mono", "CD3-T", "Mono / Neu", "Other immune"))) %>%
  group_by(niche)%>%mutate(cells = paste(unique(cell_type),collapse='\n'))%>%
  # mutate(region=str_replace_all(region," x NA",""))%>%
  # group_by(region)%>%
  # mutate(cellPh2 = paste(unique(cell_type),collapse="\n"))%>%
  # ungroup()%>%
  # mutate(cellPh = ifelse(region %in% pull(archs.CT,region),paste(archs.CT[archs.CT$region==region,"cell_type"],collapse="\n"),"")) %>%
  group_by(niche,cell_type)%>% 
  mutate(cell_phenotype= paste0(paste(marker, collapse = " "),cell_type)) %>%
  ungroup()%>%

  group_by(niche)%>%
  mutate(cell_phenotype=paste(unique(cell_phenotype),collapse="\n")) %>%
  distinct(niche, .keep_all = TRUE)%>%
  arrange(niche)%>%dplyr::select(niche, cells,cell_phenotype)

tabCellPhen3 <- tabCellPhen2%>%
  #mutate(region=str_replace_all(region," x NA",""))%>%
  mutate(cellPh =ifelse(niche %in% pull(archs.CT,niche),paste(archs.CT[archs.CT$niche==niche ,"cell_type"],collapse="\n"),""))%>%
  rowwise()%>%
  mutate(ct = ifelse(grepl("\n",cellPh,fixed=TRUE)==FALSE,paste(setdiff(as.vector(cellPh),str_split(cells,"\n")[[1]]),collapse="\n"),ifelse(grepl("\n",cells,fixed=TRUE)==FALSE,paste(setdiff(str_split(cellPh,"\n")[[1]], as.vector(cells)),collapse="\n"),paste(setdiff(str_split(cellPh,"\n")[[1]],str_split(cells,"\n")[[1]]),collapse="\n"))))%>%
  mutate(cell_phenotype = paste(cell_phenotype,ct,sep="\n"),.keep="unused")%>%
  dplyr::select(-c(cells, cellPh))%>%#mutate(sign  = "+")
  #distinct(region, .keep_all = TRUE)%>%
  arrange(niche)

### Display and save table in pdf
th1 <- ttheme_default()
g1 <- tableGrob(tabCellPhen3,rows=NULL,theme = th1)#(tabCellPhen2%>%mutate(region=str_replace_all(region," x NA","")),rows=NULL,theme = th1)
                 #gpar.corefill = gpar(fill = "white", col = "grey95"))
grid.newpage()
grid.draw(g1)
ggsave("./figs/tab_tmens.pdf",g1,width=7,height=10)
#rm(g1)
 

```

#### Heatmaps organized by cell types and markers


```{r corrCells,eval=TRUE }
#library("RColorBrewer")
library(pheatmap)
# cts <- unique(pull(as_tibble(cMf2,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";"),cell_type))
# 
 markersCorr <- unique(pull(as_tibble(cMf2,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";"),marker))

plot_heatmap_CT(cMf2,coreIntf2) #c('a1','a2','a3',"a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4")

plot_heatmap_markers(cMf2,coreIntf2) #c('a1','a2','a3',"a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4")

# rm(cMf.copy)
# rm(CM_TMENs_ph)
# rm(CM_TMENs_ct)
#pheatmap(t(as.matrix(CM_TMENs_ct)),cluster_cols = TRUE,cluster_rows = FALSE)

```

#### Niche-phentoype mapping per cell type 

```{r cellsTMENs,eval=TRUE}
#library(RColorBrewer)
library(pheatmap)

## Get cell types that are associated with a tmen/interface
cts <- unique(pull(as_tibble(cMf2,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";"),cell_type))
markersCorr <- unique(pull(as_tibble(cMf2,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";"),marker))

#### NEW VERSION 
# We proceed cell type wise and do hierarchical clustering of the markers to group the phenotypes together
# 1 plot for 1 cell type
# same color bar
# export heatmaps into pdf with same cell size of the matrix
# group them manually in Inkscape 
#rds  created in the function correlation_niches_CM
corrCM <- readRDS("./corMatrix_raw.rds")
# @param corrMatrix.raw: matrix of correlations between niches and cell phneotyes of dim nbCellPhenotypes x niches(and/or interfaces)

### FUNCTION ###
plot_nipmap_cellTypes <- function(corrMatrix.raw){
  corrMatrix.raw <- corrMatrix.raw[rowSums(is.na(corrMatrix.raw))==0,] # remove row with NA values
  breaksCols <- seq(min(corrMatrix.raw),max(corrMatrix.raw),by=.1) # max ad min correlations for colormap
  
  # Group by different cell types  and split it into different dfs
  ct_df <-group_split(as_tibble(corrMatrix.raw,rownames=NA)%>%rownames_to_column(var="names")%>%separate(names,into=c("cell_type","marker"),sep=";")%>%group_by(cell_type))
  
  list_heatmapsCT <- lapply(ct_df,FUN = function(x){
    ct <- str_replace(unique(x$cell_type),"/","_" )#strsplit(rownames(x)["cell_type"],';')[[1]][1]
    print(ct)
    colnames(x) <- str_replace_all(colnames(x), c("a2a3"="inflammatoryxcancer",
                                                             "a1a3" = "TLSxcancer",
                                                             "a1a2"= "TLSxinflammatory",
                                                             "a1a4" = "TLSxfibrotic",
                                                             "a2a4" ="inflammatoryxfibrotic",
                                                             "a3a4" = "cancerxfibrotic"))
    colnames(x) <- str_replace_all(colnames(x),c("a1" = "TLS","a2" = "inflammatory","a3" = "cancer","a4" = "fibrotic"))
    pdf(paste0("./figs/",ct,".pdf"));# heatmap of NIPMAP for one cell type over all phenotypic markers
    pheatmap(as.matrix(x%>%arrange(marker)%>%column_to_rownames(var="marker")%>%dplyr::select(-(cell_type))),#x%>%mutate(names= paste(cell_type,marker),.keep="unused")%>%column_to_rownames(var="names")),#%>%t()),
                                                       color = colorRampPalette(rev(RColorBrewer::brewer.pal(n = 7,name = "RdYlBu")))( length(breaksCols)), cluster_cols = TRUE,
                                                       cluster_rows = FALSE,main=ct,
                                                       cell_width=1,cell_height = 2);
    dev.off()
    
  })
}
plot_nipmap_cellTypes(corrMatrix.raw=corrCM)


```

#### PCA on correlation matrix of cell markers VS TMENs

Can we find cross-cells phenotypes that are associated to niches ? Are they associated to core niches or do they arise at the interface ?
If so, is it a continuum or do we have clusters ?

```{r pcaCor, eval=FALSE,fig.height = 15,fig.width=15,echo=TRUE}
#FIXME remove this part ? Useless
###PCA on correlation matrix
library(pheatmap)
#library(RColorBrewer)
library(ggplot2)
CM_TMENs.pca <- dudi.pca(cMf[,c('a1','a2','a3',"a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4")],center=FALSE, scale=TRUE,scannf=FALSE,nf=3)
fviz_eig(CM_TMENs.pca)
fviz_pca_var(CM_TMENs.pca,col.var = "red",repel=TRUE)
fviz_pca_var(CM_TMENs.pca,axes=c(1,3),col.var = "red",repel=TRUE)
fviz_pca_ind(CM_TMENs.pca)
CM <- cMf%>%as_tibble(rownames=NA)%>%rownames_to_column(var="names")%>%separate(col=names, into=c("cell_type","marker"),sep=";")%>%dplyr::select(c(cell_type,marker))

# CM_TMENs.pca$co[,1:3] <- sweep(CM_TMENs.pca$co[,1:3], 2, CM_TMENs.pca$eig[1:3]^0.8, FUN='/')
# CM_TMENs.pca$li[,1:3] <- sweep(CM_TMENs.pca$li[,1:3], 2, CM_TMENs.pca$eig[1:3], FUN='/')

colorCount = length(unique(CM$marker))
getPalette = colorRampPalette(RColorBrewer::brewer.pal(9, "Set1"))


# plot1 <- ggplot(data = cbind(CM_TMENs.pca$li[,1:2],CM), aes(x = Axis1, y = Axis2,color=marker,shape= cell_type,size=3)) + 
#       geom_point()+scale_color_manual(values=getPalette(colorCount))+
#   scale_shape_manual(values=c(0,1,2,3,4,5,6,7,8,9,10,12,13,16,17,18))+#c(0:length(unique(CM$cell_type))-1)
#           xlab("PC 1") + ylab("PC 2")
# 
# plot1

# plot2 <- ggplot(data = cbind(CM_TMENs.pca$li[,1:3],CM), aes(x = Axis1, y = Axis3,color=marker,shape= cell_type,size=3)) + 
#       geom_point()+scale_color_manual(values=getPalette(colorCount))+
#   scale_shape_manual(values=c(0,1,2,3,4,5,6,7,8,9,10,12,13,16,17,18))+#c(0:length(unique(CM$cell_type))-1)
#           xlab("PC 1") + ylab("PC 3")
# 
# 
# plot2
# 
# 
fig1 <- plot_ly(x = CM_TMENs.pca$li[,1],
           y = CM_TMENs.pca$li[,2],
           z = CM_TMENs.pca$li[,3],
           type="scatter3d",
           #color = ~markerCells,
           alpha = 0.5,
           mode="markers",
           name= "cells",
           marker = list(size= 5),
           showlegend=TRUE)%>%
    layout(scene = list(xaxis = list(title = "PC1"),
                                       yaxis = list(title = "PC2"),
                                       zaxis = list(title = "PC3") ))
#fig1

```



```{r plotsa2a3,eval=FALSE,echo=TRUE}
corr_cm <-as_tibble(cMf2,rownames=NA)%>%rownames_to_column(var="names")%>%separate(col=names, into=c("cell_type","marker"),sep=";")%>%filter(!(cell_type %in% c("DC / Mono", "Mono / Neu","Other immune")))%>%mutate(marker=ifelse(marker%in%c("phospho-S6","Beta catenin","HLA_Class_1"),marker,"other"))#%>%group_by(marker)%>%mutate(randA2 = ifelse(marker=="other",rnorm(),))
#library(RColorBrewer)
#library(tune)
colorCount = length(unique(corr_cm$marker))
#getPalette = colorRampPalette(brewer.pal(9, "Set1"))#Dark2

ggplot(corr_cm, aes(x=a3,y=a2,color=marker,shape=cell_type))+
  geom_hline(yintercept=0, color="black",linetype= "dashed") + geom_vline(xintercept=0,color="black",linetype="dashed")+
  geom_point(size = 4)+#scale_color_brewer(palette="Set1")+#scale_color_manual(values=getPalette(colorCount))+
  scale_shape_manual(values=c(0,1,2,3,4,5,6,7,8,9,10,12,13,16,17,18))+# scale_shape_manual(values = c(0,3,18,7))++# 7,3,5
  scale_color_manual(values=c("#DB121F","#DBA012","#999999","#DB129F"))+
  ylab("Association to inflammatory niche")+xlab("Association to cancer niche")+
  
  xlim(-0.5,max(cbind(corr_cm$a2,corr_cm$a3))) + ylim(-0.5,max(cbind(corr_cm$a2,corr_cm$a3)))
ggsave("./figs/corrCancerInfl.pdf",width=6,height=4)
  
  
```

#### Sum of Squares of correlations per TMENs (core and interfaces)

To understand with cores/interfaces of TMENs associate (positively or negatively) best to environment, we compute the sum of squares of the spearman correlations for each environment:

```{r SScors}
#install.packages("ggrepel")
library(ggrepel)
coreCorr <- cMf2[,c('a1','a2','a3',"a4")]
interCorr <- cMf2[,c("a1a2","a1a3","a1a4","a2a3","a2a4","a3a4")]
SS <- apply(cMf2[,c('a1','a2','a3',"a4","a1a2","a1a3","a1a4","a2a3","a2a4","a3a4")],2, function(x) sum(x)^2)#var(x) #sum(x-mean(x))^2
sort(SS)
names(SS) <- str_replace_all(names(SS), c("a2a3"="inflammatory x cancer",
                                                           "a1a3" = "TLS x cancer",
                                                           "a1a2"= "TLS x inflammatory",
                                                           "a1a4" = "TLS x fibrotic",
                                                           "a2a4" ="inflammatory x fibrotic",
                                                           "a3a4" = "cancer x fibrotic"))
names(SS) <- str_replace_all(names(SS),archNames )

x <- rep(0,length(SS))
tmens_SS <- as_tibble(cbind(SS,x),rownames=NA)%>%rownames_to_column(var="tmen")%>%mutate(type = ifelse(tmen %in% c("TLS","inflammatory","cancer","fibrotic"),"core","interface"))
p <- ggplot(tmens_SS , aes(x, SS,color=type,label=tmen)) + geom_point()+ylab("Sum of squares of association scores of all phenotypes")+geom_text_repel()
p + theme(axis.line.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.x=element_blank(),
          panel.grid.minor.x=element_blank(),
          panel.grid.major.x=element_blank())
ggsave("./figs/SS_tmens.pdf",height=4,width=3)

```

 * The interface between cancer and inflammatory niches is highly correlated with specific phenotypes. It associates the most phenotypes with environment. 
 
 * Many cell phenotypes highly associate with the fibrotic niche (mostly anti-correlations): most cells anti-correlate with this niche because it has a low cell density. We also lack stromal markers and ECM markers as well as some cytokines. 
 
 * The cancer niche has an average SS, it correlates with cell phenotypes observed such as beta catenin, phospho S6 and keratin. 
 
 * The inflammatory niche is the third environment whose SS is high meaning that it highly correlates with cell phenotypes that are likely to be pro-inflammatory
 
 * Cell phenotypes poorly correlate with a TLS-cancer niches interface. This suggests that either there is no phenotype that is specific to this environment or simply that we find almost no cells at this interface or that the panel of markers doesn't cover proteins that might be in this region.
 
 * In general, interfaces with TLS have a poor SS value. It reveals that there are few phenotypes that highly associate with those specific immune contextures, or that phenotypes poorly associate with them.
 
 In conclusion, cancer-inflammation interface is the interface that associates best phenotypes with space. In other words, this is the context for generation of environment-dependent cell phenotypes such as antigen presentation or immunosuppression. Previous work reveal that the latter enhances tumor growth and immune escape


## Methods

**Defining the environment of the cells.**

In order to understand how environment associates with cell phenotypes, we described the environment surrounding the cells using TMENs. Therefore, each cell will be computed the proportions of TMENs. 
We generated sites centered on cells from MIBI data. Thus, there are as many sites as cells. We computed the cell abundance across sites. We defined the proportions $\alpha$ of TMENs of a cell as is: $\rho = B \alpha$, where $\rho$ is the cell abundance in a site centered on the cell and B is the  matrix of cellular profile for each TMENs.
To find $\alpha$, we solved the equation with quadratic programming using *qpsolvers* library in Python. Cells labeled as "Unidentified" by Keren 2018 were discarded from the analysis.

**Correlations between cell phenotypes and environment.**

Having the cells and their environment ($\alpha$ for each cell), we collected the expression of protein markers cell type-wise. We selected only markers that were classified as "functional" according to [this paper](https://doi.org/10.1038/s42003-021-02361-1) (Patwa et al., Nature 2021). Cell phenotypes were defined as the expression of a marker in a cell type. We computed Spearman correlations between cell phenotypes and TMENs. We included the interfaces between TMENs as the product of different combinations of TMENs: TLS x cancer, cancer x fibrotic, cancer x inflammation, TLS x fibrotic, TLS x inflammatory, fibrotic x inflammatory, TLS x inflammatory x fibrotic, TLS x cancer x fibrotic, inflammatory x fibrotic x cancer, TLS x inflammatory x cancer, TLS x inflammatory x fibrotic x cancer.
Spearman correlation test was performed with a False Discovery Rate correction of p values. We selected only significant q values ($\alpha = 0.01$) and the cell phenotypes whose correlation coefficient was higher than $0.3$ for at least one of the environments (core TMENs and interfaces). High range interfaces between TMENs ($> 2$) were excluded as they were less informative than 2-range interfaces. In total, we kept 75 correlations between cell phenotypes and 10 core and interfaces of TMENs. To correct for bleed-over, Keratin6-positive cell phenotypes that were associated with cancer and cancer-inflammatory niches interface were removed from the analysis. We filtered out beta-catenin-positive cell phenotypes as the marker used in the antibody panel was not specific to any form of the protein. These supplemental corrections led to 59 space-driven cell phenotypes. The analysis was conducted in R. 

